<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sofia - Assistente Virtual</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="avatar">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <div class="header-info">
                    <h1>Sof I.A</h1>
                    <p class="status" id="status">
                        <span class="status-dot"></span>
                        <span id="status-text">Online</span>
                    </p>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" id="metaverse-btn" title="Entrar no Metaverso 3D">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="4"/>
                            <line x1="12" y1="2" x2="12" y2="8"/>
                            <line x1="12" y1="16" x2="12" y2="22"/>
                            <line x1="4.93" y1="4.93" x2="9.17" y2="9.17"/>
                            <line x1="14.83" y1="14.83" x2="19.07" y2="19.07"/>
                        </svg>
                    </button>
                    <button class="icon-btn" id="stats-btn" title="Estatísticas da Memória">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="20" x2="12" y2="10"/>
                            <line x1="18" y1="20" x2="18" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="16"/>
                        </svg>
                    </button>
                    <button class="icon-btn" id="settings-btn" title="Configurações">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

                <!-- Chat Container -->
        <div class="chat-container" id="chat-container">
            <div class="welcome-message">
                ...
            </div>
        </div>

        <!-- Painel de Telemetria TRQ + Qwen -->
        <section id="painel-trq" class="painel-trq">
            <header class="painel-header">
                <h2>Telemetria TRQ + Qwen</h2>
                <div class="painel-buttons">
                    <button id="btn-atualizar-trq">Atualizar telemetria</button>
                    <button id="btn-otimizar-trq">Rodar Qwen (otimizar)</button>
                </div>
            </header>

            <div class="painel-conteudo">
                <div>
                    <h3>Execuções recentes</h3>
                    <pre id="trq-logs" class="painel-box">Nenhum dado ainda.</pre>
                </div>
                <div>
                    <h3>Sugestão do Qwen</h3>
                    <pre id="trq-qwen-sugestao" class="painel-box">Clique em "Rodar Qwen (otimizar)" para gerar sugestão.</pre>
                </div>
            </div>
        </section>

        <!-- Input Area -->
        <div class="input-area">
            ...

        <div class="input-area">
            <div class="input-container">
                <button id="attach-btn" class="attach-btn" title="Anexar imagem ou PDF">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                    </svg>
                </button>
                <input type="file" id="file-input-chat" accept="image/*,.pdf" multiple hidden>
                <textarea 
                    id="message-input" 
                    placeholder="Digite aqui..."
                    rows="1"
                ></textarea>
                <button id="web-search-btn" class="web-search-btn" title="Buscar na Web">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                </button>
                <button id="send-btn" class="send-btn" title="Enviar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            
            <!-- Attached Files Preview -->
            <div id="attached-files-preview" class="attached-files-preview" style="display: none;">
                <div class="attached-files-list" id="attached-files-list"></div>
            </div>
            
            <!-- Botões removidos - memória automática ativa -->
        </div>
    </div>

    <!-- Modal de Estatísticas da Memória -->
    <div class="modal" id="stats-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Estatísticas da Memória</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="stats-content">
                <div class="loading">Carregando estatísticas...</div>
            </div>
        </div>
    </div>

    <!-- Modal de Configurações -->
    <div class="modal" id="settings-modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Configurações</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-tabs">
                <button class="tab-btn active" data-tab="memory-tab">Memória</button>
                <button class="tab-btn" data-tab="cleanup-tab">Limpeza</button>
                <button class="tab-btn" data-tab="preferences-tab">Preferências</button>
            </div>
            <div class="modal-body">
                <!-- Aba Memória -->
                <div class="tab-content active" id="memory-tab">
                    <h4>Histórico de Conversas</h4>
                    <p class="text-muted">Visualize e gerencie suas conversas salvas</p>
                    
                    <div class="search-box">
                        <input type="text" id="search-conversations" placeholder="Buscar conversas...">
                        <button id="search-btn" class="btn-secondary">Buscar</button>
                    </div>
                    
                    <div id="conversations-list" class="conversations-list">
                        <div class="loading">Carregando conversas...</div>
                    </div>
                </div>

                <!-- Aba Limpeza -->
                <div class="tab-content" id="cleanup-tab">
                    <h4>Gerenciar Memória</h4>
                    <p class="text-muted">Limpe dados temporários ou permanentes</p>
                    
                    <div class="cleanup-section">
                        <div class="cleanup-card">
                            <div class="cleanup-icon">Cache</div>
                            <div class="cleanup-info">
                                <h5>Limpar Cache</h5>
                                <p>Remove apenas o histórico da sessão atual. Mantém conversas e aprendizados salvos.</p>
                            </div>
                            <button class="btn-secondary" id="clear-cache-btn">Limpar Cache</button>
                        </div>

                        <div class="cleanup-card">
                            <div class="cleanup-icon">Conversas</div>
                            <div class="cleanup-info">
                                <h5>Limpar Conversas</h5>
                                <p>Remove todas as conversas salvas. Mantém aprendizados importantes.</p>
                            </div>
                            <button class="btn-warning" id="clear-conversations-btn">Limpar Conversas</button>
                        </div>
                    </div>
                </div>

                <!-- Aba Preferências -->
                <div class="tab-content" id="preferences-tab">
                    <h4>Preferências</h4>
                    <p class="text-muted">Personalize sua experiência</p>
                    
                    <div class="preference-group">
                        <label for="language-select">
                            <span class="preference-icon">Idioma:</span>
                        </label>
                        <select id="language-select" class="select-input">
                            <option value="pt-BR" selected>Portugues (Brasil)</option>
                            <option value="en-US">English (US)</option>
                            <option value="es-ES">Espanol</option>
                            <option value="fr-FR">Francais</option>
                        </select>
                    </div>

                    <div class="preference-group">
                        <label for="theme-select">
                            <span class="preference-icon">Tema:</span>
                        </label>
                        <select id="theme-select" class="select-input">
                            <option value="dark" selected>Escuro</option>
                            <option value="light">Claro</option>
                            <option value="auto">Automatico</option>
                        </select>
                    </div>

                    <div class="preference-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="save-history" checked>
                            <span>Salvar historico automaticamente</span>
                        </label>
                    </div>

                    <div class="preference-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="show-timestamps" checked>
                            <span>Mostrar horarios nas mensagens</span>
                        </label>
                    </div>

                    <button class="btn-primary" id="save-preferences-btn">Salvar Preferencias</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal do Metaverso 3D com NPCs (Babylon.js) -->
    <div class="modal" id="metaverse-modal">
        <div class="modal-content modal-fullscreen">
            <div class="modal-header">
                <h3>Metaverso Sofia - Mundo Livre com NPCs</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body metaverse-body">
                <div id="metaverse-container">
                    <!-- Canvas será criado dinamicamente pelo Babylon.js -->
                    <div class="metaverse-crosshair"></div>
                </div>
                
                <!-- Painel de Missões -->
                <div id="mission-tracker" class="metaverse-panel" style="top: 300px; left: 20px; width: 260px;">
                    <div class="panel-header">
                        <h3 class="panel-title">🎯 Missões Ativas</h3>
                        <div class="panel-controls">
                            <button class="panel-btn minimize" title="Minimizar">−</button>
                            <button class="panel-btn close" title="Fechar">×</button>
                        </div>
                    </div>
                    <div class="panel-body" id="mission-list">
                        <div style="display: grid; gap: 8px; font-size: 0.9em;">
                            <div class="mission-item mission-active">
                                <div class="mission-icon">🌸</div>
                                <div class="mission-content">
                                    <div class="mission-title">Conhecer Sofia</div>
                                    <div class="mission-desc">Fale com a Sofia no jardim</div>
                                </div>
                            </div>
                            <div class="mission-item mission-pending">
                                <div class="mission-icon">🗺️</div>
                                <div class="mission-content">
                                    <div class="mission-title">Explorar o Mundo</div>
                                    <div class="mission-desc">Descubra todos os NPCs</div>
                                </div>
                            </div>
                            <div class="mission-item mission-pending">
                                <div class="mission-icon">🔑</div>
                                <div class="mission-content">
                                    <div class="mission-title">Encontrar Segredos</div>
                                    <div class="mission-desc">Explore áreas ocultas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Painel de Prompt de Interação -->
                <div id="interaction-prompt" class="metaverse-panel" style="display: none; bottom: 120px; left: 50%; transform: translateX(-50%); width: auto; max-width: 400px;">
                    <div class="panel-header">
                        <h3 class="panel-title">💬 Interação</h3>
                        <div class="panel-controls">
                            <button class="panel-btn minimize" title="Minimizar">−</button>
                            <button class="panel-btn close" title="Fechar">×</button>
                        </div>
                    </div>
                    <div class="panel-body" id="interaction-prompt-text">
                        <p>Pressione <kbd>E</kbd> para interagir</p>
                    </div>
                </div>
                
                <!-- Painel de Diálogo -->
                <div id="dialog-box" class="metaverse-panel" style="display: none; bottom: 180px; left: 50%; transform: translateX(-50%); width: auto; max-width: 500px;">
                    <div class="panel-header">
                        <h3 class="panel-title">💭 Diálogo</h3>
                        <div class="panel-controls">
                            <button class="panel-btn minimize" title="Minimizar">−</button>
                            <button class="panel-btn close" title="Fechar">×</button>
                        </div>
                    </div>
                    <div class="panel-body" id="dialog-box-text">
                        <p>Conversa com NPC...</p>
                    </div>
                </div>
                
                <!-- Painel de Status da Sofia -->
                <div class="metaverse-panel" id="metaverse-status" style="display: none; top: 20px; right: 20px; width: 280px;">
                    <div class="panel-header">
                        <h3 class="panel-title">🤖 Status Sofia</h3>
                        <div class="panel-controls">
                            <button class="panel-btn minimize" title="Minimizar">−</button>
                            <button class="panel-btn close" title="Fechar">×</button>
                        </div>
                    </div>
                    <div class="panel-body" id="metaverse-status-text">
                        <p style="color: #2cb67d; margin: 0;">✨ Sofia está online</p>
                    </div>
                </div>
                
                <!-- Painel de Orientação de Movimentos (Tutorial) -->
                <div class="metaverse-panel" id="movement-guide" style="top: 20px; left: 20px; width: 260px;">
                    <div class="panel-header">
                        <h3 class="panel-title">🎮 Guia de Movimento</h3>
                        <div class="panel-controls">
                            <button class="panel-btn minimize" title="Minimizar">−</button>
                            <button class="panel-btn close" title="Fechar">×</button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div style="display: grid; gap: 8px; font-size: 0.9em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <kbd style="min-width: 30px; text-align: center;">W</kbd>
                                <span>Avançar</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <kbd style="min-width: 30px; text-align: center;">S</kbd>
                                <span>Recuar</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <kbd style="min-width: 30px; text-align: center;">A</kbd>
                                <span>Esquerda</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <kbd style="min-width: 30px; text-align: center;">D</kbd>
                                <span>Direita</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <kbd style="min-width: 60px; text-align: center;">Shift</kbd>
                                <span>Correr</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <kbd style="min-width: 60px; text-align: center;">Mouse</kbd>
                                <span>Olhar ao redor</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Painel de Chat com Sofia -->
                <div class="metaverse-panel" id="metaverse-chat-panel" style="bottom: 20px; right: 20px; width: 350px;">
                    <div class="panel-header">
                        <h3 class="panel-title">🌸 Chat com Sofia</h3>
                        <div class="panel-controls">
                            <button class="panel-btn minimize" title="Minimizar">−</button>
                            <button class="panel-btn close" title="Fechar">×</button>
                        </div>
                    </div>
                    <div class="panel-body" style="padding: 0; max-height: 300px; display: flex; flex-direction: column;">
                        <div id="metaverse-messages" style="flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; max-height: 240px;"></div>
                        <div class="metaverse-input" style="padding: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1); display: flex; gap: 8px;">
                            <input type="text" id="metaverse-input-text" placeholder="Converse com Sofia..." autocomplete="off" style="flex: 1; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 8px 12px; color: white; font-size: 0.9em;">
                            <button id="metaverse-send-btn" style="background: linear-gradient(135deg, #2cb67d 0%, #1e8a5f 100%); border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; transition: all 0.2s ease;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Babylon.js CDN -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    
    <!-- Scripts do projeto -->
    <script src="script.js?v=websocket-fix"></script>
    <script src="metaverse_babylon.js"></script>
</body>
</html>
